<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSP Component Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0a0a0f',
                            800: '#12121a',
                            700: '#1a1a24',
                            600: '#22222e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-hover:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.12);
        }
        .version-pill.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
        }
        /* Dev pills: dim when inactive, bright with ring when active */
        .version-pill.dev-main:not(.active),
        .version-pill.dev-next:not(.active) {
            opacity: 0.6;
            filter: saturate(0.7);
        }
        .version-pill.dev-main.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5), 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 1;
            filter: saturate(1);
        }
        .version-pill.dev-next.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.5), 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 1;
            filter: saturate(1);
        }
        .stale-badge {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        .cve-badge-critical {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }
        .cve-badge-high {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
        }
        .cve-badge-medium {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }
        .cve-badge-low {
            background: linear-gradient(135deg, #65a30d 0%, #4d7c0f 100%);
        }
        .cve-badge-unknown {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        .mismatch-badge {
            background: rgba(255, 255, 255, 0.2);
        }
        .version-pill.dev-main {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .version-pill.dev-next {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        .deps-toggle {
            cursor: pointer;
            user-select: none;
        }
        .deps-toggle:hover {
            color: #60a5fa;
        }
        .deps-row.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-dark-900 text-gray-100 min-h-screen">
    <!-- Background gradient -->
    <div class="fixed inset-0 bg-gradient-to-br from-blue-900/20 via-purple-900/10 to-dark-900 pointer-events-none"></div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent mb-2">
                OSP Component Dashboard
            </h1>
            <p class="text-gray-400">OpenShift Pipelines version tracking</p>
        </header>

        <!-- Version Selector -->
        <div class="flex flex-col items-center gap-4 mb-6">
            <!-- Development versions (main/next) - shown first as primary options -->
            <div class="flex items-center gap-4">
                <span class="text-xs text-gray-500 uppercase tracking-wide">Development</span>
                <div class="flex gap-3">
                    {% for version in versions %}
                    {% if version == 'next' %}
                    <button
                        class="version-pill dev-next px-6 py-2 rounded-full text-sm font-medium transition-all duration-200 hover:scale-105 text-white"
                        onclick="showVersion('{{ version }}')"
                        data-version="{{ version }}"
                    >
                        üöÄ next
                        <span class="ml-1 text-xs opacity-75">(latest releases)</span>
                        {% if version_stats[version].has_go_mismatch or version_stats[version].has_dep_mismatch %}
                        <span class="ml-1 text-yellow-200">‚ö†</span>
                        {% endif %}
                    </button>
                    {% elif version == 'main' %}
                    <button
                        class="version-pill dev-main px-6 py-2 rounded-full text-sm font-medium transition-all duration-200 hover:scale-105 text-white"
                        onclick="showVersion('{{ version }}')"
                        data-version="{{ version }}"
                    >
                        üå± main
                        <span class="ml-1 text-xs opacity-75">(bleeding edge)</span>
                        {% if version_stats[version].has_go_mismatch or version_stats[version].has_dep_mismatch %}
                        <span class="ml-1 text-yellow-200">‚ö†</span>
                        {% endif %}
                    </button>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            <!-- Release versions -->
            <div class="flex items-center gap-4">
                <span class="text-xs text-gray-500 uppercase tracking-wide">Releases</span>
                <div class="flex flex-wrap gap-3">
                    {% for version in versions %}
                    {% if version not in ['main', 'next'] %}
                    <button
                        class="version-pill px-6 py-2 rounded-full glass text-sm font-medium transition-all duration-200 hover:scale-105 text-gray-300 hover:text-white"
                        onclick="showVersion('{{ version }}')"
                        data-version="{{ version }}"
                    >
                        OSP {{ version }}
                        {% if version_stats[version].has_go_mismatch or version_stats[version].has_dep_mismatch %}
                        <span class="ml-1 text-yellow-400" title="{% if version_stats[version].has_go_mismatch %}Go version mismatch{% endif %}{% if version_stats[version].has_go_mismatch and version_stats[version].has_dep_mismatch %}, {% endif %}{% if version_stats[version].has_dep_mismatch %}Dependency version mismatch{% endif %}">‚ö†</span>
                        {% endif %}
                        {% if version_stats[version].total_cves > 0 %}
                        <span class="ml-1 text-red-400" title="{{ version_stats[version].total_cves }} CVE(s) affecting this version">üõ°</span>
                        {% endif %}
                    </button>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>


        <!-- Component Cards Container -->
        {% for version in versions %}
        <div
            id="version-{{ version }}"
            class="version-content hidden"
        >
            <!-- Version-level status ribbon -->
            {% set has_issues = version_stats[version].has_go_mismatch or version_stats[version].has_dep_mismatch or version_stats[version].total_cves > 0 or version_stats[version].total_dep_cves > 0 or version_stats[version].has_vuln_data %}
            {% if has_issues %}
            <div class="mb-6 p-4 rounded-lg bg-amber-500/10 border border-amber-500/30 space-y-2">
                {% if version_stats[version].has_go_mismatch %}
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-yellow-400 text-lg">‚ö†</span>
                    <span class="text-yellow-400 font-medium">Go mismatch:</span>
                    <span class="text-yellow-300">{{ version_stats[version].go_versions | join(', ') }}</span>
                </div>
                {% endif %}

                {% if version_stats[version].has_dep_mismatch %}
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-yellow-400 text-lg">‚ö†</span>
                    <span class="text-yellow-400 font-medium">Dep mismatch:</span>
                    <span class="text-yellow-300">{{ version_stats[version].mismatched_deps | join(', ') }}</span>
                </div>
                {% endif %}

                {% if version_stats[version].total_cves > 0 %}
                <div class="flex items-center gap-2 text-sm flex-wrap">
                    <span class="text-red-400 text-lg">üõ°</span>
                    <span class="text-red-400 font-medium">Component CVEs:</span>
                    {% for cve in version_stats[version].cve_details %}
                    <a href="{{ cve.url }}" target="_blank" class="text-red-300 hover:text-red-200">{{ cve.id }} ({{ cve.component }})</a>{% if not loop.last %}<span class="text-gray-600">,</span>{% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                {% if version_stats[version].total_dep_cves > 0 %}
                <div class="flex items-center gap-2 text-sm flex-wrap">
                    <span class="text-red-400 text-lg">üõ°</span>
                    <span class="text-red-400 font-medium">Dependency CVEs:</span>
                    {% for cve in version_stats[version].dep_cve_details %}
                    <a href="{{ cve.url }}" target="_blank" class="text-red-300 hover:text-red-200">{{ cve.id }} ({{ cve.dep }})</a>{% if not loop.last %}<span class="text-gray-600">,</span>{% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                {% if version_stats[version].has_vuln_data %}
                <div class="flex items-center gap-2 text-sm flex-wrap">
                    <span class="text-purple-400 text-lg">üîç</span>
                    {% if version_stats[version].total_vulns > 0 %}
                    <span class="text-purple-400 font-medium">govulncheck ({{ version_stats[version].called_vulns }} called / {{ version_stats[version].total_vulns }} total):</span>
                    {% for vuln in version_stats[version].vuln_details[:10] %}
                    <span class="{% if vuln.is_called %}text-red-300{% else %}text-purple-300{% endif %}">{{ vuln.id }} ({{ vuln.component }}{% if vuln.is_called %} ‚ö°{% endif %})</span>{% if not loop.last %}<span class="text-gray-600">,</span>{% endif %}
                    {% endfor %}
                    {% if version_stats[version].vuln_details | length > 10 %}
                    <span class="text-gray-500">... +{{ version_stats[version].vuln_details | length - 10 }} more</span>
                    {% endif %}
                    {% else %}
                    <span class="text-green-400 font-medium">govulncheck: 0 reachable vulnerabilities ‚úì</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Table View -->
            <div class="table-view overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Component</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Ref</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Go</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Stale Deps</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Mismatched Deps</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">CVEs</th>
                            <th class="text-right py-3 px-4 text-gray-400 font-medium">Deps</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp in versions_data[version] %}
                        <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                            <td class="py-3 px-4">
                                <a href="https://github.com/{{ comp.owner }}/{{ comp.repo }}" target="_blank" class="text-white hover:text-blue-400 transition-colors font-medium">
                                    {{ comp.repo }}
                                </a>
                            </td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-0.5 rounded bg-blue-500/20 text-blue-300 font-mono text-xs font-medium">
                                    {{ comp.ref }}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <span class="{% if comp.go_version_mismatch %}text-yellow-400{% else %}text-gray-200{% endif %} font-mono text-xs">
                                    {{ comp.go_version }}{% if comp.go_version_mismatch %} ‚ö†{% endif %}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                {% set stale_deps = comp.internal_deps | selectattr('is_stale') | list %}
                                {% if stale_deps %}
                                <div class="flex flex-wrap gap-x-3 gap-y-1">
                                    {% for dep in stale_deps %}
                                    <span class="font-mono text-xs" title="{{ dep.path }} (bundled: {{ dep.bundled_version }})">
                                        <span class="text-orange-300">{{ dep.path.split('/')[-1] }}</span><span class="text-orange-500">@{{ dep.version }}</span>
                                    </span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <span class="text-gray-600">-</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4">
                                {% set mismatched_deps = comp.external_deps | selectattr('version_differs') | list %}
                                {% if mismatched_deps %}
                                <div class="flex flex-wrap gap-x-3 gap-y-1">
                                    {% for dep in mismatched_deps %}
                                    <span class="font-mono text-xs" title="{{ dep.path }} (expected: {{ dep.expected_version }})">
                                        <span class="text-gray-300">{{ dep.path.split('/')[-1] }}</span><span class="text-gray-400">@{{ dep.version }}</span>
                                    </span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <span class="text-gray-600">-</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4">
                                {% set ns = namespace(has_cves=false, has_vulns=false) %}
                                {% for dep in comp.external_deps %}{% if dep.cves %}{% set ns.has_cves = true %}{% endif %}{% endfor %}
                                {% if comp.vulns %}{% set ns.has_vulns = true %}{% endif %}
                                {% if ns.has_cves or ns.has_vulns or comp.cves %}
                                <div class="flex flex-wrap gap-x-2 gap-y-1">
                                    {# Component CVEs from GitHub Advisory #}
                                    {% for cve in comp.cves %}
                                    <a href="{{ cve.url }}" target="_blank" class="inline-flex items-center gap-1 font-mono text-xs" title="{{ cve.id }}: {{ cve.summary }}">
                                        <span class="px-1 py-0.5 rounded bg-red-500/20 text-red-300">GH</span>
                                        <span class="text-red-400">{{ cve.id }}</span>
                                    </a>
                                    {% endfor %}
                                    {# Dependency CVEs from GitHub Advisory #}
                                    {% for dep in comp.external_deps %}
                                    {% if dep.cves %}
                                    {% for cve in dep.cves %}
                                    <a href="{{ cve.url }}" target="_blank" class="inline-flex items-center gap-1 font-mono text-xs" title="{{ cve.id }} in {{ dep.path }}">
                                        <span class="px-1 py-0.5 rounded bg-red-500/20 text-red-300">GH</span>
                                        <span class="text-red-400">{{ dep.path.split('/')[-1] }}</span>
                                    </a>
                                    {% endfor %}
                                    {% endif %}
                                    {% endfor %}
                                    {# Vulns from govulncheck #}
                                    {% for vuln in comp.vulns %}
                                    <span class="inline-flex items-center gap-1 font-mono text-xs" title="{{ vuln.id }}: {{ vuln.summary }}{% if vuln.is_called %} (CALLED){% endif %}">
                                        <span class="px-1 py-0.5 rounded {% if vuln.is_called %}bg-purple-500/30 text-purple-200{% else %}bg-purple-500/20 text-purple-300{% endif %}">VC{% if vuln.is_called %}!{% endif %}</span>
                                        <span class="{% if vuln.is_called %}text-purple-200{% else %}text-purple-400{% endif %}">{{ vuln.module }}</span>
                                    </span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <span class="text-gray-600">-</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 text-right">
                                <span class="deps-toggle text-gray-400 hover:text-blue-400" onclick="toggleDeps('{{ version }}-{{ comp.repo }}')" title="Click to show all dependencies">
                                    {{ comp.total_deps }} ‚ñº
                                </span>
                            </td>
                        </tr>
                        <!-- Expandable dependencies row -->
                        <tr id="deps-{{ version }}-{{ comp.repo }}" class="deps-row hidden bg-dark-800/50">
                            <td colspan="7" class="py-3 px-4">
                                <div class="grid grid-cols-2 gap-4">
                                    {% if comp.internal_deps %}
                                    <div>
                                        <p class="text-xs text-orange-400 uppercase tracking-wider mb-2">Tekton Dependencies</p>
                                        <div class="space-y-1">
                                            {% for dep in comp.internal_deps %}
                                            <div class="flex justify-between text-xs">
                                                <span class="{% if dep.is_stale %}text-red-300{% else %}text-orange-200{% endif %} truncate" title="{{ dep.path }}">
                                                    {{ dep.path.split('/')[-1] }}
                                                </span>
                                                <span class="{% if dep.is_stale %}text-red-400{% else %}text-orange-400{% endif %} font-mono">
                                                    {{ dep.version }}{% if dep.is_stale %} (stale){% endif %}
                                                </span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if comp.external_deps %}
                                    <div>
                                        <p class="text-xs text-purple-400 uppercase tracking-wider mb-2">External Dependencies</p>
                                        <div class="space-y-1">
                                            {% for dep in comp.external_deps %}
                                            <div class="flex justify-between text-xs">
                                                <span class="{% if dep.cves %}text-red-300{% elif dep.version_differs %}text-yellow-300{% else %}text-gray-300{% endif %} truncate" title="{{ dep.path }}">
                                                    {{ dep.path.split('/')[-1] }}
                                                </span>
                                                <span class="{% if dep.cves %}text-red-400{% elif dep.version_differs %}text-yellow-400{% else %}text-purple-400{% endif %} font-mono">
                                                    {{ dep.version }}{% if dep.version_differs %} (exp: {{ dep.expected_version }}){% endif %}
                                                </span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}

        <!-- Legend -->
        <div class="mt-16 glass rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Legend</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div>
                    <h4 class="text-gray-300 font-medium mb-2">Vulnerability Sources</h4>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <span class="px-1.5 py-0.5 rounded bg-red-500/20 text-red-300 font-mono text-xs">GH</span>
                            <span class="text-gray-400"><strong class="text-gray-300">GitHub Advisory</strong> ‚Äî CVE exists in dependency version range. May not be exploitable.</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-300 font-mono text-xs">VC</span>
                            <span class="text-gray-400"><strong class="text-gray-300">govulncheck</strong> ‚Äî Vulnerability detected but code path not called.</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="px-1.5 py-0.5 rounded bg-purple-500/30 text-purple-200 font-mono text-xs">VC!</span>
                            <span class="text-gray-400"><strong class="text-gray-300">govulncheck (called)</strong> ‚Äî Vulnerable code is actually reachable. <strong class="text-red-400">Action required.</strong></span>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-gray-300 font-medium mb-2">Status Indicators</h4>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <span class="text-yellow-400">‚ö†</span>
                            <span class="text-gray-400"><strong class="text-gray-300">Go mismatch</strong> ‚Äî Components use different Go versions.</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="stale-badge px-1.5 py-0.5 rounded text-[10px] font-bold text-white">STALE</span>
                            <span class="text-gray-400"><strong class="text-gray-300">Stale dependency</strong> ‚Äî Uses older version than bundled in this release.</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="mismatch-badge px-1.5 py-0.5 rounded text-[10px] font-bold text-white">MISMATCH</span>
                            <span class="text-gray-400"><strong class="text-gray-300">Version mismatch</strong> ‚Äî Different versions across components in same release.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-8 space-y-3">
            <p class="text-gray-400 text-sm">
                Vibed with <span class="text-pink-400">‚ô•</span> by
                <a href="https://github.com/vdemeester" class="bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent hover:from-purple-400 hover:to-pink-400 transition-all">@vdemeester</a>
            </p>
            <p class="text-gray-600 text-xs">
                <a href="https://github.com/openshift-pipelines/osp-component-dashboard" class="hover:text-blue-400 transition-colors">Source</a>
                <span class="mx-2 text-gray-700">¬∑</span>
                <a href="https://github.com/openshift-pipelines" class="hover:text-purple-400 transition-colors">OpenShift Pipelines</a>
            </p>
        </footer>
    </div>

    <script>

        function showVersion(version) {
            // Hide all version content
            document.querySelectorAll('.version-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Show selected version content
            document.getElementById('version-' + version).classList.remove('hidden');

            // Update pill styles - handle both regular and dev pills
            document.querySelectorAll('.version-pill').forEach(pill => {
                const isDevPill = pill.classList.contains('dev-main') || pill.classList.contains('dev-next');
                if (pill.dataset.version === version) {
                    pill.classList.add('active');
                    if (!isDevPill) {
                        pill.classList.add('text-white');
                        pill.classList.remove('text-gray-300');
                    }
                } else {
                    pill.classList.remove('active');
                    if (!isDevPill) {
                        pill.classList.remove('text-white');
                        pill.classList.add('text-gray-300');
                    }
                }
            });
        }

        function toggleDeps(id) {
            const row = document.getElementById('deps-' + id);
            const toggle = event.target;
            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                toggle.textContent = toggle.textContent.replace('‚ñº', '‚ñ≤');
            } else {
                row.classList.add('hidden');
                toggle.textContent = toggle.textContent.replace('‚ñ≤', '‚ñº');
            }
        }

        // On page load, default to 'next' version
        document.addEventListener('DOMContentLoaded', function() {
            const versions = [{% for v in versions %}'{{ v }}'{% if not loop.last %}, {% endif %}{% endfor %}];
            const defaultVersion = versions.includes('next') ? 'next' : versions[0];
            showVersion(defaultVersion);
        });
    </script>
</body>
</html>
